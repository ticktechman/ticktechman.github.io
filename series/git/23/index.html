<!DOCTYPE html>

<html lang="en">

<head>
  
  
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-8H7XPB6TV4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-8H7XPB6TV4');
  </script>
  
  
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6745756499567894"
    crossorigin="anonymous"></script>
  
  <meta charset="UTF-8">
  
  <meta name="description" content="如何使用钩子脚本关闭github问题单">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Git使用-利用钩子实现自动化</title>
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">
  <link rel="stylesheet" href="/assets/css/syntax.dark.css">
</head>

<body>
  <header class="">
  <div name="bar">
    <a href='/'><img name="logo" src="/assets/images/logo.webp"></a>
    <ul name="menu-h-area">
      <li>
        <a href='/'
          class=''>主页
        </a>
      </li>
      <li>
        <a href='/blog'
          class=''>博客
        </a>
      </li>
      <li>
        <a href='/series'
          class='current-menu'>专栏
        </a>
      </li>
      <li>
        <a href='/archive'
          class=''>归档
        </a>
      </li>
      <li>
        <a href='/about'
          class=''>关于
        </a>
      </li>
    </ul>
    <div class="flex flow-col space-x-4 items-center place-content-center">
      <button id="btn-menu" class="flex md:hidden" onclick="toggleMainMenu(event)">
        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14">
          <path stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M1 1h15M1 7h15M1 13h15"></path>
        </svg>
      </button>
      <div id="main-menu-hidden" class="menu-hidden duration-300">
        <ul id="main-menu-ul">
          <li><a href='/'>主页</a></li>
          <li><a href='/blog'>博客</a></li>
          <li><a href='/series'>专栏</a></li>
          <li><a href='/archive'>归档</a></li>
          <li><a href='/about'>关于</a></li>
        </ul>
      </div>
      <button class="flex">
        <img id="language-selection" src="/assets/images/icon/lang-zh.svg" width="32"
          onclick="toggleLanguageMenu(event)" />
        <ul id="language-ul" class="menu-hidden duration-300">
          <li><a href='/'><img src="/assets/images/icon/lang-zh.svg" width="32" /></a></li>
          <li><a href='/en'><img src="/assets/images/icon/lang-en.svg" width="32" /></a></li>
        </ul>
      </button>
      <button class="flex" id="dark-mode">
        <svg class="w-6 h-6 block dark:hidden" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
          p-id="7091" xmlns:xlink="http://www.w3.org/1999/xlink">
          <path fill="currentcolor"
            d="M512 783.945143a261.997714 261.997714 0 0 0 192.292571-79.725714A261.997714 261.997714 0 0 0 783.945143 512a261.997714 261.997714 0 0 0-79.725714-192.292571A261.997714 261.997714 0 0 0 512 240.054857c-36.790857 0-74.386286 8.484571-112.64 25.526857 46.811429 21.211429 84.699429 54.125714 113.737143 98.742857 28.964571 44.617143 43.52 93.842286 43.52 147.675429 0 53.833143-14.555429 103.058286-43.52 147.675429a263.899429 263.899429 0 0 1-113.664 98.742857A275.894857 275.894857 0 0 0 512 783.945143z m363.300571-422.765714L1024 512l-148.699429 150.820571v212.48H662.820571L512 1024l-150.820571-148.699429H148.699429V662.820571L0 512l148.699429-150.820571V148.699429h212.48L512 0l150.820571 148.699429h212.48v212.48z"
            p-id="7092"></path>
        </svg>
        <svg class="w-6 h-6 hidden dark:block" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
          p-id="5081" xmlns:xlink="http://www.w3.org/1999/xlink">
          <path fill="currentcolor"
            d="M502.518519 246.518519a256 256 0 1 0 0 512 256 256 0 0 0 0-512z m0 94.814814a161.185185 161.185185 0 1 1 0 322.370371 161.185185 161.185185 0 0 1 0-322.370371zM512 9.481481a48.545185 48.545185 0 0 1 48.279704 43.538963l0.227555 4.968297v72.628148a48.545185 48.545185 0 0 1-96.786963 4.968296l-0.227555-4.93037V57.950815C463.454815 31.213037 485.224296 9.481481 512 9.481481zM867.365926 156.634074a48.545185 48.545185 0 0 1 3.299555 64.967111l-3.337481 3.678815-51.351704 51.351704a48.545185 48.545185 0 0 1-71.945481-64.929185l3.337481-3.678815 51.351704-51.351704c18.962963-18.962963 49.682963-18.962963 68.645926 0zM1014.518519 512a48.545185 48.545185 0 0 1-43.538963 48.279704l-4.968297 0.227555h-72.628148a48.545185 48.545185 0 0 1-4.968296-96.786963l4.93037-0.227555h72.666074c26.775704 0 48.507259 21.731556 48.50726 48.507259zM867.365926 867.365926a48.545185 48.545185 0 0 1-64.967111 3.299555l-3.678815-3.337481-51.351704-51.351704a48.545185 48.545185 0 0 1 64.929185-71.945481l3.678815 3.337481 51.351704 51.351704c18.962963 18.962963 18.962963 49.682963 0 68.645926zM512 1014.518519a48.545185 48.545185 0 0 1-48.279704-43.538963l-0.227555-4.968297v-72.628148a48.545185 48.545185 0 0 1 96.786963-4.968296l0.227555 4.93037v72.666074A48.545185 48.545185 0 0 1 512 1014.518519zM156.634074 867.365926a48.545185 48.545185 0 0 1-3.299555-64.967111l3.337481-3.678815 51.351704-51.351704a48.545185 48.545185 0 0 1 71.945481 64.929185l-3.337481 3.678815-51.351704 51.351704c-18.962963 18.962963-49.682963 18.962963-68.645926 0zM9.481481 512a48.545185 48.545185 0 0 1 43.538963-48.279704l4.968297-0.227555h100.882963a48.545185 48.545185 0 0 1 4.968296 96.786963l-4.93037 0.227555H58.026667A48.545185 48.545185 0 0 1 9.481481 512zM156.634074 156.634074a48.545185 48.545185 0 0 1 64.967111-3.299555l3.678815 3.337481 51.351704 51.351704a48.545185 48.545185 0 0 1-64.929185 71.945481l-3.678815-3.337481L156.672 225.28c-18.962963-18.962963-18.962963-49.682963 0-68.645926z"
            p-id="5082"></path>
        </svg>
      </button>
    </div>
  </div>
</header>
  
<main class="pb-16 w-full bg-slate-50 dark:bg-slate-900 dark:border-none">
  
  <img class="w-full h-[200px] md:h-[300px] lg:h-[400px] object-cover shadow-md" src="/series/git/images/default.webp" alt="">
  
  <h2 class="pt-4 text-center">Git使用-利用钩子实现自动化</h2>
  <h4 class="text-center text-gray-400 text-sm mb-3">
    <span class="px-1 py-2">2024/05/15</span>
    <span class="px-1 py-2">|</span>
    <span class="px-1 py-2">字数2364</span>
    <span class="px-1 py-2">|</span>
    <span class="px-1 py-2">阅读5分钟</span>
  </h4>
  <hr class="w-4/5 sm:w-4/5 md:w-2/3 xl:w-1/2">

  
  <div id="page-content" class="mx-auto min-w-[340px] w-4/5 md:w-3/4 lg:w-2/3">
    <h1 id="什么是钩子hooks">什么是钩子（Hooks）</h1>
<p>钩子是git提供的一个扩展机制，允许用户在某个重要操作的【前&amp;后】执行一段程序（可以是脚本，当然也可以是二进制可执行文件），以此来触发一个外部事件。利用这个机制，可以用来做合规性检查、触发持续集成、自动化测试等。</p>
<p>依照不同分类规则，钩子程序可以分为：</p>
<p><strong>按执行位置分类：</strong></p>
<ul>
<li>客户端钩子：在本地触发和执行；</li>
<li>服务端钩子：在服务器触发和执行；</li>
</ul>
<p><strong>按触发时机分类：</strong></p>
<ul>
<li>前置钩子（pre-hooks）：在某个操作前被执行，执行失败（返回非零值）则取消用户操作，钩子名称一般以<code>pre-</code>开头；</li>
<li>后置钩子（post-hooks）：在某个操作后被执行；无论是否执行成功都不影响用户操作；</li>
</ul>
<p>目前git(v2.41.0)中支持的钩子包括：</p>
<ul>
<li>applypatch-msg</li>
<li>pre-applypatch</li>
<li>post-applypatch</li>
<li>pre-commit</li>
<li>pre-merge-commit</li>
<li>prepare-commit-msg</li>
<li>commit-msg</li>
<li>post-commit</li>
<li>pre-rebase</li>
<li>post-checkout</li>
<li>post-merge</li>
<li>pre-push</li>
<li>pre-receive（服务端）</li>
<li>update（服务端）</li>
<li>proc-receive（服务端）</li>
<li>post-receive（服务端）</li>
<li>post-update（服务端）</li>
<li>reference-transaction</li>
<li>push-to-checkout（服务端）</li>
<li>pre-auto-gc</li>
<li>post-rewrite</li>
<li>sendemail-validate</li>
<li>fsmonitor-watchman</li>
<li>p4-changelist</li>
<li>p4-prepare-changelist</li>
<li>p4-post-changelist</li>
<li>p4-pre-submit</li>
<li>post-index-change</li>
</ul>
<blockquote>
<p>想了解每个hook的触发时机，可以阅读<code>git help hooks</code>文档，这里不做赘述。</p>
</blockquote>
<h1 id="怎么用">怎么用</h1>
<p>知道了有哪些钩子，以及触发时机，下面我们看看如何添加一个钩子程序</p>
<p><strong>客户端：</strong></p>
<p>客户端的钩子存放在<code>.git/hooks/</code>目录下，需要用到哪个钩子，只需要添加一个对应的文件就可以了，注意钩子文件的名称，需要和上一节中的名称保持一致，同时为钩子文件增加执行权限。</p>
<blockquote>
<p>类unix系统，可以执行<code>chmod u+x &lt;hook-file&gt;</code>增加执行权限；</p>
</blockquote>
<p><strong>服务端：</strong></p>
<p>至于服务端，就比较麻烦一点，一般的git服务器软件都提供了web配置页面，供用户定制，一般不会通过修改脚本文件的方式。下面分别是github和gitlab的webhook配置页面：
<div class="carousel">
  

<div class="carousel-item ease-in-out w-full duration-1000 translate-x-full">
  <img src='/series/git/images/githooks-001.webp' />
  <div class="comments" style="scrollbar-width: thin;">
    <ol>
<li>github webhook配置界面</li>
</ol>
<p>可以订阅关心的各种类型的事件，同时需要提供一个HTTP服务地址，用于接收事件，这个服务器需要自建。</p>

  </div>
</div>

<div class="carousel-item ease-in-out w-full duration-1000 translate-x-full">
  <img src='/series/git/images/githooks-002.webp' />
  <div class="comments" style="scrollbar-width: thin;">
    <ol start="2">
<li>gitlab webhook配置界面</li>
</ol>
<p>和github类似</p>

  </div>
</div>

  

  <div class="z-12 w-full absolute top-1/3 flex flex-row justify-between ">
    
    <svg name="left" class="m-2 cursor-pointer" onclick="carousel_left(event, this)" width="32" height="32"
      viewBox="0 0 48 48" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg">
      <path style="fill:#888;fill-opacity:1;fill-rule:evenodd;stroke:#fff;stroke-width:1.88976;stroke-opacity:1"
        d="m 30.554843,43.284079 c 0.687984,0 1.375176,-0.263847 1.902345,-0.791015 1.054336,-1.054337 1.054336,-2.752304 0,-3.806641 L 17.765782,23.995017 32.457188,9.3055642 c 1.054336,-1.0543365 1.054336,-2.752305 0,-3.8066415 -1.054337,-1.0543365 -2.752305,-1.0543358 -3.806641,7e-7 L 12.156406,21.993064 c -0.55262,0.552621 -0.811837,1.283099 -0.785156,2.003906 -0.02668,0.720807 0.232536,1.449332 0.785156,2.001953 l 16.494141,16.494141 c 0.527168,0.527167 1.216314,0.791015 1.904296,0.791015 z" />
    </svg>
    
    <svg name="right" class="m-2 cursor-pointer" onclick="carousel_right(event, this)" width="32" height="32"
      viewBox="0 0 48 48" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg">
      <path style="fill:#888;fill-opacity:1;fill-rule:evenodd;stroke:#fff;stroke-width:1.88976;stroke-opacity:1"
        d="m 16.683301,-10.523738 c -0.486478,0.486478 -0.785828,1.1589645 -0.785828,1.904493 0,1.491057 1.200644,2.6917014 2.691701,2.6917014 H 39.36596 l -0.0014,20.7754046 c 0,1.491057 1.200645,2.691702 2.691702,2.691702 1.491057,0 2.691701,-1.200645 2.691701,-2.691702 V -8.478376 c 0,-0.781524 -0.333232,-1.4813441 -0.861786,-1.972165 -0.490821,-0.528554 -1.18926,-0.860405 -1.970784,-0.860405 H 18.589174 c -0.745528,0 -1.419396,0.300731 -1.905873,0.787208 z"
        transform="rotate(45)" />
    </svg>
  </div>
</div></p>
<p>不过，如果你通过标准的ssh服务来搭建git服务，而不是复杂的gitlab或github服务，也可以通过修改<code>.git/hooks</code>目录下的脚本来实现钩子。</p>
<h1 id="举个例子">举个例子</h1>
<p>这里我们利用<code>post-receive</code>钩子来关闭gitlab issue的功能。这是一个服务器端的钩子，在收到客户端的push后触发。我们的钩子脚本会检查是否是一个bugfix提交，同时检查里面是否包含issue的编号，如果有，修改对应的issue状态为close。我们这里用的语言是python，代码如下：</p>
<div class="flex flex-col bg-[#eee8d5] my-2 rounded-xl overflow-hidden shadow dark:bg-[#282c34]">
    <div class="mt-2 mx-4 flex flex-row">
        <div class="rounded-full size-3 bg-red-400 ml-1.5 my-auto"></div>
        <div class="rounded-full size-3 bg-yellow-400 ml-1.5 my-auto"></div>
        <div class="rounded-full size-3 bg-green-400 ml-1.5 my-auto"></div>
        <div class=" font-mono grow text-center">python</div>
    </div>
    <div class="flex flex-row mx-4 my-3">
        <div class="grow text-white text-nowrap overflow-auto scroll" style="scrollbar-color: #ccc #282c34;scrollbar-width: thin;">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># post-receive</span>
</span></span><span class="line"><span class="cl"><span class="c1"># run: pip install gitpython requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">git</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># change THIS to your own token and project id</span>
</span></span><span class="line"><span class="cl"><span class="n">GITLAB_TOKEN</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">GITLAB_PROJECT_ID</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;/tmp/post-recv.log&#39;</span><span class="p">,</span> <span class="n">filemode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">close_issue</span><span class="p">(</span><span class="n">IID</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">GITLAB_URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;https://gitlab.com/api/v4/projects/</span><span class="si">{</span><span class="n">GITLAB_PROJECT_ID</span><span class="si">}</span><span class="s2">/issues/</span><span class="si">{</span><span class="n">IID</span><span class="si">}</span><span class="s2">?state_event=close&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">HEADERS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;PRIVATE-TOKEN&#34;</span><span class="p">:</span> <span class="n">GITLAB_TOKEN</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">GITLAB_URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">HEADERS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># logging.info(f&#34;issue {IID} closed&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;failed with status:</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">extract_issue_id</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;fix: &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#(\d+)\s+&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="k">match</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">repo</span> <span class="o">=</span> <span class="n">git</span><span class="o">.</span><span class="n">Repo</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">oneline</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># logging.info(oneline)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># oneline format: HASH1 HASH2 refname</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># example: 50d688ea0b85ac401450bbeae897fd2e38ed1b21 dc0f390584b057c11a865c486b293ff593279e13 refs/heads/master</span>
</span></span><span class="line"><span class="cl">    <span class="n">record</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">oneline</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">str</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&#34;..&#34;</span> <span class="o">+</span> <span class="n">record</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">one_commit</span> <span class="ow">in</span> <span class="n">repo</span><span class="o">.</span><span class="n">iter_commits</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># logging.info(one_commit.message)</span>
</span></span><span class="line"><span class="cl">        <span class="n">iid</span> <span class="o">=</span> <span class="n">extract_issue_id</span><span class="p">(</span><span class="n">one_commit</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">iid</span> <span class="o">!=</span> <span class="s2">&#34;&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">iid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">close_issue</span><span class="p">(</span><span class="n">iid</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div>
        </div>
        <div class="flex-none pl-1 text-right cursor-pointer" onclick="copyCode(this);">
            <svg name="copy-code" class="duration-500" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 48 48" fill="#ccc">
                <path d="M9 43.95q-1.2 0-2.1-.9-.9-.9-.9-2.1V10.8h3v30.15h23.7v3Zm6-6q-1.2 0-2.1-.9-.9-.9-.9-2.1v-28q0-1.2.9-2.1.9-.9 2.1-.9h22q1.2 0 2.1.9.9.9.9 2.1v28q0 1.2-.9 2.1-.9.9-2.1.9Zm0-3h22v-28H15v28Zm0 0v-28 28Z"/>
            </svg>
            <svg name="copy-success" viewBox="0 0 1024 1024" class="hidden duration-500" width="24" fill="#0a0"><path d="M911.075556 192.796444a45.511111 45.511111 0 0 1 5.518222 64.113778l-455.111111 540.444445a45.511111 45.511111 0 0 1-68.835556 0.910222l-227.555555-256a45.511111 45.511111 0 0 1 68.039111-60.472889l192.625777 216.689778 421.205334-500.224a45.511111 45.511111 0 0 1 64.113778-5.461334z" p-id="5114"></path></svg>
        </div>
        <div class="hidden">#!/usr/bin/env python3

# post-receive
# run: pip install gitpython requests
import git
import logging
import sys
import re
import requests

# change THIS to your own token and project id
GITLAB_TOKEN = &#34;&#34;
GITLAB_PROJECT_ID = &#34;&#34;

logging.basicConfig(level=logging.INFO, filename=&#39;/tmp/post-recv.log&#39;, filemode = &#39;a&#39;, format = &#39;%(asctime)s - %(levelname)s: %(message)s&#39;)

def close_issue(IID):
    GITLAB_URL = f&#34;https://gitlab.com/api/v4/projects/{GITLAB_PROJECT_ID}/issues/{IID}?state_event=close&#34;
    HEADERS = {&#34;PRIVATE-TOKEN&#34;: GITLAB_TOKEN}
    result = requests.put(GITLAB_URL, headers=HEADERS)
    if result.status_code == 200:
        # logging.info(f&#34;issue {IID} closed&#34;)
    else:
        logging.error(f&#34;failed with status:{result.status_code}&#34;)


def extract_issue_id(msg):
    if msg.startswith(&#34;fix: &#34;):
        match = re.search(r&#39;#(\d&#43;)\s&#43;&#39;, msg)
        if match:
            return match.group(1)
        else:
            return &#34;&#34;
    else:
        return &#34;&#34;


repo = git.Repo(&#39;.&#39;)
for oneline in sys.stdin:
    # logging.info(oneline)
    # oneline format: HASH1 HASH2 refname
    # example: 50d688ea0b85ac401450bbeae897fd2e38ed1b21 dc0f390584b057c11a865c486b293ff593279e13 refs/heads/master
    record = re.split(r&#39;\s&#43;&#39;, oneline)
    str = record[0] &#43; &#34;..&#34; &#43; record[1]
    for one_commit in repo.iter_commits(str):
        # logging.info(one_commit.message)
        iid = extract_issue_id(one_commit.message)
        if iid != &#34;&#34;:
            logging.info(iid)
            close_issue(iid)</div>
    </div>
</div>
<p>上面的脚本中，需要修改<code>GITLAB_TOKEN</code>和<code>GITLAB_PROJECT_ID</code>，在你的项目中创建一个访问的TOKEN（Settings &gt; Access Tokens），项目ID在Settings &gt; General页面可以看到。修改完成后，将上面的脚本放到服务器端<code>your-project.git/hooks/post-receive</code>中，并添加执行权限<code>chmod +x your-project.git/hooks/post-receive</code>。这个钩子程序需要用到python3、pip3以及三方库：<code>pip3 install requests gitpython</code></p>
<p>然后在客户端增加一个提交记录，在提交的消息中包含<code>git commit -m &quot;fix: #1 issue 1 fixed&quot;</code>，这里以<code>fix: </code>开头，同时issue编号是以<code>#</code>开头的数字。</p>
<p>这样你在客户端执行<code>git push</code>的时候，就会在服务端触发<code>post-receive</code>脚本，关闭对应的issue。上面的logging是为了调试使用，调试通过后，建议关闭日志打印。这个程序也能处理多个commit记录，一次性push到git服务器的场景。</p>
<blockquote>
<p>这个脚本也可以扩展，用来修改Jira/Github等平台的issue状态；</p>
</blockquote>
<h1 id="局限">局限</h1>
<ol>
<li><code>.git/hooks</code>目录下的钩子程序在执行<code>git clone</code>时，并不会被下载到客户端，因此对于本地钩子需要通过其他方式来存储；比较好的方式是将这些钩子程序保存到git库上，可以单独存放在一个目录，例如<code>.githooks/</code>目录下，克隆仓库完成后，执行一下<code>git config --local core.hooksPath .githooks/</code>，将hooks对应的目录设置到新的目录下；</li>
<li>gitlab/github等服务端默认的webhook需要自建一个HTTP服务器，来实现事件通知；另外存放在服务器上的<code>your-project.git/hooks/</code>下的服务器端的钩子程序，并没有提供web页面以供修改，需要登陆到git服务器上，手动修改对应的钩子文件，存在一定的安全隐患；</li>
<li>对于钩子程序中用到的基础软件、依赖包等，需要提前在git服务器上安装，否则无法执行；</li>
</ol>
<h1 id="注意事项">注意事项</h1>
<ul>
<li>保持钩子程序代码精简，快速结束，否则严重影响git效率；</li>
<li>仔细阅读每个钩子触发机制、输入参数、标准输入、返回值要求等信息，避免出现场景遗漏；</li>
<li>选择一种你熟悉的语言来编写，常见的shell、python、nodejs、ruby、golang、C等随你选。如果是我的话，优选shell和python，开发效率高；</li>
</ul>
<h1 id="参考">参考</h1>
<ul>
<li><a href="https://githooks.com/">https://githooks.com/</a></li>
<li><a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks</a></li>
</ul>

  </div>
  

  <div class="mx-auto flex flex-row justify-between mt-8 min-w-[340px] w-4/5 md:w-3/4 lg:w-2/3">
    
    <a class="block px-4 py-2 text-sm text-gray-400 mx-1 bg-black/5 rounded italic hover:text-blue-500 dark:bg-white/10"
      href="/series/git/22/">上一篇：高效Git-如何快速下载代码</a>
    
    
    <a class="block px-4 py-2 text-sm text-gray-400 mx-1 bg-black/5 rounded italic hover:text-blue-500 dark:bg-white/10"
      href="/series/git/24/">下一篇：Git使用-commit信息怎么写</a>
    
  </div>
  
  <div class="flex flex-col mt-2 mx-auto min-w-[340px] w-4/5 md:w-3/4 lg:w-2/3">
    <p class="mx-auto font-bold text-red-500 cursor-pointer" onclick="coffee(this);">【文章不错，鼓励一下】</p>
    <img src="/assets/images/like.webp" class="mx-auto w-[280px] rounded-md border shadow hidden">
  </div>
  
</main>

<div id="page-model-image-diag"
  class="mx-auto items-center overflow-auto w-full h-full bg-black/80 fixed z-99 top-0 left-0 hidden"
  onclick="hideImageDiag(event, this)">
  <img src="" class="mx-auto max-w-[100vw] max-h-[100vh] cursor-zoom-in rounded-lg shadow-lg duration-500"
    onclick="largeImageClick(event);" onkeypress="largeImagePress(event)" ondblclick="imageZoomIn(event, this)">
</div>

  <footer>
  <div class="flex text-sm text-gray-400"> © ticktechman 2024</div>
  
</footer>
  <script src="/assets/js/dark-mode.js"></script>
  <script src="/assets/js/main.js"></script>
</body>

</html>